<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ PikPak Bot Admin</title>
    <link rel="stylesheet" href="/static/admin.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>üé¨ PikPak-Telegram Bot</h1>
                <span class="version" id="version">v2.0.0</span>
            </div>
            <div class="header-right">
                <button onclick="clearAllTrash()" class="btn btn-warning">üóëÔ∏è Clear All Trash</button>
                <button onclick="clearAllMyPack()" class="btn btn-danger">üìÅ Clear All My Pack</button>
                <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-danger" id="emergencyBtn" onclick="toggleEmergency()">
                    üî¥ EMERGENCY STOP
                </button>
            </div>
        </header>

        <!-- System Status Cards -->
        <section class="section">
            <h2 class="section-title">üìä System Status</h2>
            <div class="cards">
                <div class="card">
                    <div class="card-icon" id="statusIcon">üü¢</div>
                    <div class="card-value" id="systemStatus">Online</div>
                    <div class="card-label">Status</div>
                </div>
                <div class="card">
                    <div class="card-icon">üîÑ</div>
                    <div class="card-value" id="queueCount">0</div>
                    <div class="card-label">Queue</div>
                </div>
                <div class="card">
                    <div class="card-icon">‚úÖ</div>
                    <div class="card-value" id="completedCount">0</div>
                    <div class="card-label">Completed</div>
                </div>
                <div class="card">
                    <div class="card-icon">‚ùå</div>
                    <div class="card-value" id="failedCount">0</div>
                    <div class="card-label">Failed</div>
                </div>
                <div class="card">
                    <div class="card-icon">üì¶</div>
                    <div class="card-value" id="sessionsCount">0</div>
                    <div class="card-label">Sessions</div>
                </div>
                <div class="card">
                    <div class="card-icon">üíæ</div>
                    <div class="card-value" id="totalRemaining">0</div>
                    <div class="card-label">Quota Left</div>
                </div>
            </div>
        </section>

        <!-- Accounts Section -->
        <section class="section">
            <h2 class="section-title">üë§ PikPak Accounts</h2>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Email</th>
                            <th>Usage</th>
                            <th>Storage</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="accountsTable">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Test Magnet Section -->
        <section class="section">
            <h2 class="section-title">üß™ Test Magnet</h2>
            <div class="test-magnet">
                <div class="input-group">
                    <input type="text" id="testMagnetInput" placeholder="Paste magnet link here..." class="input">
                    <button class="btn btn-primary" onclick="testMagnet()">Test</button>
                </div>
                <div class="test-result" id="testResult">
                    <p class="test-placeholder">Enter a magnet link to test validity and file info</p>
                </div>
            </div>
        </section>

        <!-- Active Sessions -->
        <section class="section">
            <h2 class="section-title">üì¶ Active Sessions</h2>
            <div class="sessions-list" id="sessionsList">
                <p class="empty-state">No active sessions</p>
            </div>
        </section>

        <!-- Reports Section -->
        <section class="section">
            <h2 class="section-title">üìä Today's Report</h2>
            <div class="cards report-cards">
                <div class="card">
                    <div class="card-icon">üì•</div>
                    <div class="card-value" id="todayDownloads">0</div>
                    <div class="card-label">Downloads</div>
                </div>
                <div class="card">
                    <div class="card-icon">üì§</div>
                    <div class="card-value" id="todayUploads">0</div>
                    <div class="card-label">Uploads</div>
                </div>
                <div class="card">
                    <div class="card-icon">‚è±Ô∏è</div>
                    <div class="card-value" id="avgTime">0s</div>
                    <div class="card-label">Avg Time</div>
                </div>
                <div class="card">
                    <div class="card-icon">üíæ</div>
                    <div class="card-value" id="totalData">0 MB</div>
                    <div class="card-label">Total Data</div>
                </div>
            </div>

            <!-- Account Usage Bars -->
            <div class="usage-bars">
                <h3>Account Usage</h3>
                <div id="usageBars">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </section>

        <!-- Recent Activity -->
        <section class="section">
            <h2 class="section-title">üìã Recent Activity</h2>
            <div class="activity-list" id="activityList">
                <p class="empty-state">No recent activity</p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>Last updated: <span id="lastUpdate">-</span></p>
        </footer>
    </div>

    <script>
        // Global state
        let emergencyStop = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
        });

        // Refresh all data
        async function refreshData() {
            try {
                const response = await fetch('/admin/api/status');
                const data = await response.json();
                updateDashboard(data);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Failed to fetch data:', error);
                document.getElementById('systemStatus').textContent = 'Error';
                document.getElementById('statusIcon').textContent = 'üî¥';
            }
        }

        // Update dashboard with data
        function updateDashboard(data) {
            // System status
            document.getElementById('version').textContent = data.system.version || 'v2.0.0';
            document.getElementById('systemStatus').textContent = data.system.status || 'Unknown';
            document.getElementById('statusIcon').textContent = data.system.status === 'online' ? 'üü¢' : 'üî¥';
            document.getElementById('queueCount').textContent = data.system.queue || 0;
            document.getElementById('completedCount').textContent = data.system.completed || 0;
            document.getElementById('failedCount').textContent = data.system.failed || 0;
            document.getElementById('sessionsCount').textContent = data.system.sessions || 0;
            document.getElementById('totalRemaining').textContent = data.accounts.total_remaining || 0;

            // Emergency stop button
            emergencyStop = data.system.emergency_stop || false;
            updateEmergencyButton();

            // Accounts table
            const accountsTable = document.getElementById('accountsTable');
            accountsTable.innerHTML = '';
            
            if (data.accounts && data.accounts.list) {
                data.accounts.list.forEach(acc => {
                    const row = document.createElement('tr');
                    const statusClass = acc.available ? 'status-available' : 'status-exhausted';
                    const statusText = acc.available ? 'üü¢ Available' : 'üî¥ Exhausted';
                    const emailMasked = acc.email.replace(/(.{3})(.*)(@.*)/, '$1***$3');
                    
                    row.innerHTML = `
                        <td>${acc.id}</td>
                        <td>${emailMasked}</td>
                        <td>
                            <div class="usage-mini">
                                <div class="usage-mini-bar" style="width: ${(acc.downloads_today / 5) * 100}%"></div>
                            </div>
                            <span>${acc.downloads_today}/5</span>
                        </td>
                        <td>
                            <div class="usage-mini">
                                <div class="usage-mini-bar" style="width: ${acc.storage_percent}%"></div>
                            </div>
                            <span style="font-size: 0.85rem">${acc.storage_used_gb}GB / ${acc.storage_total_gb}GB (${acc.storage_percent}%)</span>
                        </td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>
                            <button class="btn btn-small btn-secondary" onclick="resetQuota(${acc.id})">Reset</button>
                            <button onclick="clearTrash(${acc.id})" class="btn btn-sm btn-warning" title="Clear Trash">üóëÔ∏è</button>
                            <button onclick="clearMyPack(${acc.id})" class="btn btn-sm btn-danger" title="Clear My Pack">üìÅ</button>
                        </td>
                    `;
                    accountsTable.appendChild(row);
                });
            }

            // Usage bars
            const usageBars = document.getElementById('usageBars');
            usageBars.innerHTML = '';
            
            if (data.accounts && data.accounts.list) {
                data.accounts.list.forEach(acc => {
                    const percentage = (acc.downloads_today / 5) * 100;
                    const barClass = percentage >= 100 ? 'bar-full' : percentage >= 60 ? 'bar-warning' : 'bar-ok';
                    
                    usageBars.innerHTML += `
                        <div class="usage-bar-item">
                            <span class="usage-label">Acc ${acc.id}</span>
                            <div class="usage-bar">
                                <div class="usage-bar-fill ${barClass}" style="width: ${percentage}%"></div>
                            </div>
                            <span class="usage-value">${acc.downloads_today}/5</span>
                        </div>
                    `;
                });
            }

            // Sessions
            const sessionsList = document.getElementById('sessionsList');
            if (data.sessions && data.sessions.length > 0) {
                sessionsList.innerHTML = '';
                data.sessions.forEach(session => {
                    sessionsList.innerHTML += `
                        <div class="session-item">
                            <span class="session-id">Session ${session.id}</span>
                            <span class="session-magnets">${session.magnets} magnets</span>
                            <span class="session-expires">Expires: ${session.expires_in}</span>
                        </div>
                    `;
                });
            } else {
                sessionsList.innerHTML = '<p class="empty-state">No active sessions</p>';
            }

            // Today's report
            if (data.report) {
                document.getElementById('todayDownloads').textContent = data.report.downloads || 0;
                document.getElementById('todayUploads').textContent = data.report.uploads || 0;
                document.getElementById('avgTime').textContent = data.report.avg_time || '0s';
                document.getElementById('totalData').textContent = data.report.total_data || '0 MB';
            }

            // Recent activity
            const activityList = document.getElementById('activityList');
            if (data.activity && data.activity.length > 0) {
                activityList.innerHTML = '';
                data.activity.forEach(item => {
                    const statusIcon = item.status === 'success' ? '‚úÖ' : item.status === 'failed' ? '‚ùå' : 'üîÑ';
                    activityList.innerHTML += `
                        <div class="activity-item">
                            <span class="activity-time">${item.time}</span>
                            <span class="activity-status">${statusIcon}</span>
                            <span class="activity-message">${item.message}</span>
                        </div>
                    `;
                });
            } else {
                activityList.innerHTML = '<p class="empty-state">No recent activity</p>';
            }
        }

        // Toggle emergency stop
        async function toggleEmergency() {
            const endpoint = emergencyStop ? '/emergency-resume' : '/emergency-stop';
            try {
                await fetch(endpoint, { method: 'POST' });
                emergencyStop = !emergencyStop;
                updateEmergencyButton();
                refreshData();
            } catch (error) {
                alert('Failed to toggle emergency stop');
            }
        }

        // Update emergency button appearance
        function updateEmergencyButton() {
            const btn = document.getElementById('emergencyBtn');
            if (emergencyStop) {
                btn.textContent = 'üü¢ RESUME OPERATIONS';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-success');
            } else {
                btn.textContent = 'üî¥ EMERGENCY STOP';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');
            }
        }

        // Reset quota for account
        async function resetQuota(accountId) {
            if (!confirm(`Reset quota for Account ${accountId}?`)) return;
            
            try {
                const response = await fetch(`/admin/api/reset-quota/${accountId}`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert(`Account ${accountId} quota reset!`);
                    refreshData();
                } else {
                    alert('Failed to reset quota: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to reset quota');
            }
        }

        // Test magnet
        async function testMagnet() {
            const magnet = document.getElementById('testMagnetInput').value.trim();
            const resultDiv = document.getElementById('testResult');
            
            if (!magnet) {
                resultDiv.innerHTML = '<p class="test-error">Please enter a magnet link</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p class="test-loading">üîÑ Testing magnet...</p>';
            
            try {
                const response = await fetch('/admin/api/test-magnet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ magnet: magnet })
                });
                const data = await response.json();
                
                if (data.valid) {
                    resultDiv.innerHTML = `
                        <div class="test-success">
                            <p>‚úÖ <strong>Valid Magnet</strong></p>
                            <p>üìÅ File: ${data.name || 'Unknown'}</p>
                            <p>üìä Quality: ${data.quality || 'Unknown'}</p>
                            <p>üë§ Would use: Account ${data.account || '?'}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="test-error">
                            <p>‚ùå <strong>Invalid Magnet</strong></p>
                            <p>${data.error || 'Could not parse magnet link'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = '<p class="test-error">‚ùå Failed to test magnet</p>';
            }
        }

        // Clear trash for single account
        async function clearTrash(accountId) {
            if (!confirm(`Clear trash for Account ${accountId}?`)) return;
            
            try {
                const response = await fetch(`/admin/api/clear-trash/${accountId}`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Trash cleared for Account ${accountId}!`);
                    refreshData();
                } else {
                    alert(`‚ùå Failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`‚ùå Request failed: ${error.message}`);
            }
        }

        // Clear My Pack for single account
        async function clearMyPack(accountId) {
            if (!confirm(`‚ö†Ô∏è Delete ALL files in My Pack for Account ${accountId}? This cannot be undone!`)) return;
            
            try {
                const response = await fetch(`/admin/api/clear-mypack/${accountId}`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ My Pack cleared for Account ${accountId}! (${data.files_deleted} files deleted)`);
                    refreshData();
                } else {
                    alert(`‚ùå Failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`‚ùå Request failed: ${error.message}`);
            }
        }

        // Clear trash for ALL accounts
        async function clearAllTrash() {
            if (!confirm('üóëÔ∏è Clear trash for ALL accounts?')) return;
            
            const btn = document.querySelector('.btn-warning');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Clearing...';
                
                const response = await fetch('/admin/api/clear-all-trash', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Trash cleared for ${data.accounts_cleared} accounts!`);
                    refreshData();
                } else {
                    alert(`‚ùå Failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`‚ùå Request failed: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Clear My Pack for ALL accounts
        async function clearAllMyPack() {
            if (!confirm('‚ö†Ô∏è DELETE ALL FILES in My Pack for ALL accounts?\n\nThis cannot be undone!')) return;
            if (!confirm('üö® Are you REALLY sure? This will delete everything!')) return;
            
            const btn = document.querySelector('.btn-danger:not(#emergencyBtn)');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Clearing...';
                
                const response = await fetch('/admin/api/clear-all-mypack', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ My Pack cleared for ${data.accounts_cleared} accounts!`);
                    refreshData();
                } else {
                    alert(`‚ùå Failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`‚ùå Request failed: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

    </script>
</body>
</html>